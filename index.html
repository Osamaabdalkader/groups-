<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>موقع النشر البسيط مع الصور</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f4f4f4;
            padding: 20px;
            direction: rtl;
        }

        header, footer {
            text-align: center;
            padding: 1rem;
            background-color: #2c3e50;
            color: white;
            margin-bottom: 2rem;
            border-radius: 5px;
        }

        main {
            max-width: 800px;
            margin: 0 auto;
        }

        .add-post, .posts {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="text"], textarea, input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            margin-top: 5px;
        }

        button {
            background: #2c3e50;
            color: white;
            border: none;
            padding: 12px 24px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 16px;
            transition: background 0.3s;
        }

        button:hover {
            background: #34495e;
        }

        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        .post {
            background: #f9f9f9;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
            border-right: 4px solid #2c3e50;
        }

        .post h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .post p {
            color: #555;
            margin-bottom: 15px;
            line-height: 1.8;
        }

        .post-image {
            max-width: 100%;
            border-radius: 5px;
            margin-top: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #666;
        }

        .error {
            text-align: center;
            padding: 20px;
            color: #e74c3c;
            background: #ffeaea;
            border-radius: 5px;
            margin: 10px 0;
        }

        .progress-bar {
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background: #3498db;
            border-radius: 10px;
            width: 0%;
            transition: width 0.3s;
        }

        .image-preview {
            max-width: 200px;
            max-height: 200px;
            margin-top: 10px;
            display: none;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        .timestamp {
            font-size: 12px;
            color: #888;
            text-align: left;
            direction: ltr;
        }

        .retry-button {
            background: #e74c3c;
            margin-top: 10px;
        }

        .retry-button:hover {
            background: #c0392b;
        }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
</head>
<body>
    <header>
        <h1>موقع النشر البسيط مع الصور</h1>
    </header>

    <main>
        <section class="add-post">
            <h2>أضف منشورًا جديدًا</h2>
            <form id="postForm">
                <div class="form-group">
                    <label for="title">عنوان المنشور:</label>
                    <input type="text" id="title" required>
                </div>
                <div class="form-group">
                    <label for="content">نص المنشور:</label>
                    <textarea id="content" rows="5" required></textarea>
                </div>
                <div class="form-group">
                    <label for="image">صورة المنشور (اختياري):</label>
                    <input type="file" id="image" accept="image/*">
                    <img id="imagePreview" class="image-preview" alt="معاينة الصورة">
                </div>
                <div class="progress-bar">
                    <div class="progress" id="uploadProgress"></div>
                </div>
                <button type="submit" id="submitButton">نشر</button>
            </form>
        </section>

        <section class="posts">
            <h2>المنشورات المنشورة</h2>
            <div id="postsList">
                <div class="loading">جاري تحميل المنشورات...</div>
            </div>
        </section>
    </main>

    <footer>
        <p>© 2023 موقع النشر البسيط مع الصور</p>
    </footer>

    <script>
        // حالة التطبيق
        let appInitialized = false;
        let postsListener = null;

        // تهيئة Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAzYZMxqNmnLMGYnCyiJYPg2MbxZMt0co0",
            authDomain: "osama-91b95.firebaseapp.com",
            databaseURL: "https://osama-91b95-default-rtdb.firebaseio.com",
            projectId: "osama-91b95",
            storageBucket: "osama-91b95.appspot.com",
            messagingSenderId: "118875905722",
            appId: "1:118875905722:web:1a04946bc739c14acaac83",
            measurementId: "G-48WBMZBZ43"
        };

        // Initialize Firebase
        let app, database, storage;

        try {
            app = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            storage = firebase.storage();
            appInitialized = true;
            console.log("تم تهيئة Firebase بنجاح");
        } catch (error) {
            console.error("خطأ في تهيئة Firebase:", error);
            showError("حدث خطأ في تهيئة التطبيق. يرجى تحديث الصفحة.");
        }

        // العناصر في واجهة المستخدم
        const postForm = document.getElementById('postForm');
        const postsList = document.getElementById('postsList');
        const imageInput = document.getElementById('image');
        const imagePreview = document.getElementById('imagePreview');
        const uploadProgress = document.getElementById('uploadProgress');
        const submitButton = document.getElementById('submitButton');

        // معاينة الصورة قبل الرفع
        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                imagePreview.style.display = 'none';
            }
        });

        // إرسال النموذج
        postForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!appInitialized) {
                alert("التطبيق غير مهيأ. يرجى تحديث الصفحة والمحاولة مرة أخرى.");
                return;
            }
            
            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;
            const imageFile = imageInput.files[0];
            
            // تعطيل الزر أثناء التحميل
            submitButton.disabled = true;
            submitButton.textContent = 'جاري النشر...';
            
            try {
                let imageUrl = null;
                
                // إذا كانت هناك صورة، قم برفعها أولاً
                if (imageFile) {
                    const storageRef = storage.ref();
                    const imageRef = storageRef.child('posts/' + Date.now() + '_' + imageFile.name);
                    const uploadTask = imageRef.put(imageFile);
                    
                    // تتبع تقدم الرفع
                    uploadTask.on('state_changed', 
                        (snapshot) => {
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            uploadProgress.style.width = progress + '%';
                        },
                        (error) => {
                            console.error('Error uploading image: ', error);
                            alert('حدث خطأ أثناء رفع الصورة. يرجى المحاولة مرة أخرى.');
                            submitButton.disabled = false;
                            submitButton.textContent = 'نشر';
                        }
                    );
                    
                    // انتظر اكتمال الرفع
                    await uploadTask;
                    imageUrl = await imageRef.getDownloadURL();
                }
                
                // إضافة منشور إلى قاعدة البيانات
                const newPostRef = database.ref('posts').push();
                await newPostRef.set({
                    title: title,
                    content: content,
                    imageUrl: imageUrl,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                // مسح الحقول بعد النشر
                postForm.reset();
                imagePreview.style.display = 'none';
                uploadProgress.style.width = '0%';
                alert('تم نشر المنشور بنجاح!');
                
            } catch (error) {
                console.error('Error adding post: ', error);
                alert('حدث خطأ أثناء النشر. يرجى المحاولة مرة أخرى.');
            } finally {
                // إعادة تمكين الزر
                submitButton.disabled = false;
                submitButton.textContent = 'نشر';
            }
        });

        // وظيفة لتحميل وعرض المنشورات
        function loadPosts() {
            if (!appInitialized) {
                showError("التطبيق غير مهيأ. يرجى تحديث الصفحة.");
                return;
            }
            
            // إزالة المستمع السابق إذا كان موجودًا
            if (postsListener) {
                database.ref('posts').off('value', postsListener);
            }
            
            postsList.innerHTML = '<div class="loading">جاري تحميل المنشورات...</div>';
            
            // الاستماع للتغييرات في قاعدة البيانات
            postsListener = database.ref('posts').orderByChild('timestamp').on('value', 
                (snapshot) => {
                    postsList.innerHTML = '';
                    
                    if (snapshot.exists()) {
                        const posts = [];
                        snapshot.forEach((childSnapshot) => {
                            posts.push({
                                id: childSnapshot.key,
                                ...childSnapshot.val()
                            });
                        });
                        
                        // عكس الترتيب لعرض أحدث المنشورات أولاً
                        posts.reverse().forEach((post) => {
                            const postElement = document.createElement('div');
                            postElement.classList.add('post');
                            
                            let imageHtml = '';
                            if (post.imageUrl) {
                                imageHtml = `<img src="${post.imageUrl}" alt="صورة المنشور" class="post-image" onerror="this.style.display='none'">`;
                            }
                            
                            const date = new Date(post.timestamp);
                            const formattedDate = `${date.toLocaleDateString('ar-SA')} ${date.toLocaleTimeString('ar-SA')}`;
                            
                            postElement.innerHTML = `
                                <h3>${post.title}</h3>
                                <p>${post.content}</p>
                                ${imageHtml}
                                <div class="timestamp">نشر في: ${formattedDate}</div>
                            `;
                            postsList.appendChild(postElement);
                        });
                    } else {
                        postsList.innerHTML = '<div class="loading">لا توجد منشورات حتى الآن</div>';
                    }
                }, 
                (error) => {
                    console.error('Error reading posts: ', error);
                    showError('حدث خطأ في تحميل المنشورات. <button class="retry-button" onclick="loadPosts()">إعادة المحاولة</button>');
                }
            );
        }

        // وظيفة لعرض الخطأ
        function showError(message) {
            postsList.innerHTML = `<div class="error">${message}</div>`;
        }

        // بدء تحميل المنشورات عند تحميل الصفحة
        if (appInitialized) {
            loadPosts();
        }

        // جعل الدوال متاحة عالمياً لإعادة المحاولة
        window.loadPosts = loadPosts;
        window.showError = showError;
    </script>
</body>
                    </html>
